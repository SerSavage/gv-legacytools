<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Character Creation - Gloria Victis Legacy Tools</title>
    <link rel="stylesheet" href="../music-player.css">
    <link rel="stylesheet" href="../themes/ismir-theme.css">
    <link rel="stylesheet" href="../themes/midland-theme.css">
    <link rel="stylesheet" href="../themes/sangmar-theme.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #fff;
            min-height: 100vh;
            padding-top: 50px;
        }
        
        .topmenu {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.9);
            padding: 10px;
            text-align: center;
            z-index: 1000;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .topmenu a {
            color: #fff;
            text-decoration: none;
            margin: 0 15px;
            font-size: 1em;
            transition: color 0.3s ease;
        }
        
        .topmenu a:hover {
            color: #ffff00;
        }
        
        .topmenu .new-character-btn {
            background: rgba(255, 255, 0, 0.2);
            border: 2px solid rgba(255, 255, 0, 0.4);
            border-radius: 5px;
            padding: 5px 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .topmenu .new-character-btn:hover {
            background: rgba(255, 255, 0, 0.3);
            border-color: rgba(255, 255, 0, 0.6);
        }
        
        #character-creation-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            padding-top: 50px;
        }
        
        .character-creation-container {
            text-align: center;
            padding: 35px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            max-width: 1000px;
            width: 92%;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
            overflow-x: visible;
            margin: auto;
            position: relative;
        }
        
        .character-creation-title {
            font-size: 2.5em;
            color: #fff;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .character-creation-subtitle {
            font-size: 1.15em;
            color: #ccc;
            margin-bottom: 30px;
        }
        
        .char-creation-step {
            display: none;
        }
        
        .char-creation-step.active {
            display: block;
        }
        
        .char-creation-nav {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            gap: 20px;
        }
        
        .char-creation-btn {
            padding: 12px 30px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            color: #fff;
            font-size: 1.05em;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .char-creation-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }
        
        .char-creation-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .char-creation-btn.skip {
            background: rgba(255, 255, 0, 0.2);
            border-color: rgba(255, 255, 0, 0.4);
        }
        
        .gender-selection,
        .archetype-selection {
            display: flex;
            justify-content: center;
            gap: 35px;
            flex-wrap: wrap;
            margin-top: 25px;
        }
        
        .gender-option,
        .archetype-option {
            cursor: pointer;
            position: relative;
            transition: transform 0.3s ease;
            border: 3px solid transparent;
            border-radius: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .gender-option:hover,
        .archetype-option:hover {
            transform: translateY(-5px) scale(1.05);
            border-color: rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.2);
        }
        
        .gender-option.selected,
        .archetype-option.selected {
            border-color: #ffff00;
            background: rgba(255, 255, 0, 0.2);
            box-shadow: 0 0 20px rgba(255, 255, 0, 0.5);
        }
        
        .gender-image,
        .archetype-image {
            display: block;
            width: 160px;
            height: auto;
            border-radius: 5px;
        }
        
        .gender-name,
        .archetype-name {
            margin-top: 10px;
            font-size: 1.2em;
            font-weight: bold;
            color: #fff;
        }
        
        .customization-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(75px, 1fr));
            gap: 15px;
            margin-top: 18px;
            max-height: 380px;
            overflow-y: auto;
            padding: 12px;
        }
        
        .customization-item {
            cursor: pointer;
            position: relative;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 5px;
            background: rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        
        .customization-item:hover {
            border-color: rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }
        
        .customization-item.selected {
            border-color: #ffff00;
            background: rgba(255, 255, 0, 0.2);
            box-shadow: 0 0 15px rgba(255, 255, 0, 0.4);
        }
        
        .customization-image {
            width: 100%;
            height: auto;
            display: block;
            border-radius: 4px;
        }
        
        .customization-category {
            margin-bottom: 25px;
        }
        
        .customization-category-title {
            font-size: 1.3em;
            color: #fff;
            margin-bottom: 12px;
            text-align: left;
            padding-left: 10px;
        }
        
        .nation-selection {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
            margin-top: 25px;
            margin-bottom: 220px;
            position: relative;
        }
        
        .nation-option {
            cursor: pointer;
            position: relative;
            transition: transform 0.3s ease;
            border: 3px solid transparent;
            border-radius: 10px;
            padding: 6px;
            background: rgba(255, 255, 255, 0.1);
            z-index: 10;
            pointer-events: auto;
            user-select: none;
        }
        
        .nation-option:hover {
            transform: translateY(-8px) scale(1.05);
            border-color: rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.2);
        }
        
        .nation-option.selected {
            border-color: #ffff00;
            background: rgba(255, 255, 0, 0.2);
            box-shadow: 0 0 20px rgba(255, 255, 0, 0.5);
        }
        
        .nation-image {
            display: block;
            width: 200px;
            height: auto;
            border-radius: 5px;
        }
        
        .nation-name {
            margin-top: 10px;
            font-size: 1.3em;
            font-weight: bold;
            color: #fff;
        }
        
        .nation-description {
            position: absolute;
            top: calc(100% + 15px);
            left: 50%;
            transform: translateX(-50%);
            width: 340px;
            max-width: calc(100vw - 40px);
            padding: 18px;
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            font-size: 0.95em;
            line-height: 1.6;
            color: #fff;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease, transform 0.3s ease;
            z-index: 10002;
            text-align: left;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
            white-space: normal;
        }
        
        .nation-option:hover .nation-description {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        
        #character-creation-screen {
            overflow: visible;
        }
        
        @media (max-width: 768px) {
            .character-creation-container {
                width: 98%;
                padding: 20px;
                max-width: 100%;
            }
            
            .nation-selection {
                margin-bottom: 150px;
            }
            
            .nation-description {
                width: 280px;
                font-size: 0.85em;
                padding: 12px;
            }
            
            .nation-selection {
                gap: 15px;
            }
            
            .nation-image {
                width: 150px;
            }
        }
    </style>
</head>
<body>
    <div class="topmenu">
        <a href="/">Home</a>
        <a href="/map/">Interactive Map</a>
        <a href="/database/">Item Database</a>
        <a href="/workshop/">Workshop</a>
        <a href="/builder/">Character Builder</a>
        <a href="/lore/">Lore</a>
        <button class="new-character-btn" onclick="resetCharacterCreation()">Create New Character</button>
    </div>
    
    <!-- Character Creation Screen -->
    <div id="character-creation-screen">
        <div class="character-creation-container">
            <!-- Step 1: Nation Selection -->
            <div class="char-creation-step active" id="step-nation">
                <h1 class="character-creation-title">Choose Your Nation</h1>
                <p class="character-creation-subtitle">Select your allegiance to begin</p>
                
                <div class="nation-selection">
                    <div class="nation-option" data-nation="midland">
                        <img src="resources/create_nacja1a.png" 
                             data-default="resources/create_nacja1a.png"
                             data-hover="resources/create_nacja1b.png"
                             class="nation-image" 
                             alt="Midland">
                        <div class="nation-name">Midland</div>
                        <div class="nation-description">
                            The Midlanders are a proud nation from the North. Their history can be tracked back to the days of Geliand of Hillead. Even though their realm is divided into two kingdoms, they unite in the face of a common enemy – The Empire of Azebia. The Midlanders worship the Forefather and his son, and they value honour above all else.
                        </div>
                    </div>
                    
                    <div class="nation-option" data-nation="ismir">
                        <img src="resources/create_nacja2a.png"
                             data-default="resources/create_nacja2a.png"
                             data-hover="resources/create_nacja2b.png"
                             class="nation-image" 
                             alt="Ismir">
                        <div class="nation-name">Ismir</div>
                        <div class="nation-description">
                            The Ismirs are tough but honourable clan warriors hailing from the frozen wastes of Nordheim. They are truly intimidating in their height and the ease with which they swing heavy axes. They have been raiding Midlandic lands for centuries, but they unite with Midland in the fight against Azebia.
                        </div>
                    </div>
                    
                    <div class="nation-option" data-nation="sangmar">
                        <img src="resources/create_nacja3a.png"
                             data-default="resources/create_nacja3a.png"
                             data-hover="resources/create_nacja3b.png"
                             class="nation-image" 
                             alt="Sangmar">
                        <div class="nation-name">Sangmar Empire</div>
                        <div class="nation-description">
                            Sangmar was once the greatest power in the South. However, the Empire fell when the Azebs freed themselves from its yoke and began their conquest. Today Sangmar, still full of splendour and riches, is an oasis of cultural and scientific development. The Sangarians have everything – be it wonderful weapons, armour or gilded robes – except for freedom.
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Step 2: Player Name -->
            <div class="char-creation-step" id="step-name">
                <h1 class="character-creation-title">Enter Your Player Name</h1>
                <p class="character-creation-subtitle">Choose a name for your character</p>
                
                <div style="margin-top: 30px;">
                    <input type="text" 
                           id="player-name-input" 
                           placeholder="Enter player name..." 
                           style="padding: 15px 20px; font-size: 1.2em; width: 100%; max-width: 400px; border-radius: 8px; border: 2px solid rgba(255, 255, 255, 0.3); background: rgba(255, 255, 255, 0.1); color: #fff; text-align: center;">
                    <p style="margin-top: 15px; color: #aaa; font-size: 0.9em;">This name will be saved with your character</p>
                </div>
                
                <div class="char-creation-nav">
                    <button class="char-creation-btn" onclick="charCreation.prevStep();">← Back</button>
                    <button class="char-creation-btn" onclick="charCreation.nextStep();" id="btn-next-name" disabled>Next →</button>
                </div>
            </div>
            
            <!-- Step 3: Gender Selection -->
            <div class="char-creation-step" id="step-gender">
                <h1 class="character-creation-title">Choose Your Gender</h1>
                <p class="character-creation-subtitle">Select your character's gender</p>
                
                <div class="gender-selection">
                    <div class="gender-option" data-gender="male">
                        <img src="resources/create_plecM_a.png"
                             data-default="resources/create_plecM_a.png"
                             data-hover="resources/create_plecM_b.png"
                             data-selected="resources/create_plecM_c.png"
                             class="gender-image" 
                             alt="Male">
                        <div class="gender-name">Male</div>
                    </div>
                    
                    <div class="gender-option" data-gender="female">
                        <img src="resources/create_plecK_a.png"
                             data-default="resources/create_plecK_a.png"
                             data-hover="resources/create_plecK_b.png"
                             data-selected="resources/create_plecK_c.png"
                             class="gender-image" 
                             alt="Female">
                        <div class="gender-name">Female</div>
                    </div>
                </div>
                
                <div class="char-creation-nav">
                    <button class="char-creation-btn" onclick="charCreation.prevStep();">← Back</button>
                    <button class="char-creation-btn" onclick="charCreation.nextStep();" id="btn-next-gender" disabled>Next →</button>
                </div>
            </div>
            
            <!-- Step 4: Archetype Selection (Optional) -->
            <div class="char-creation-step" id="step-archetype">
                <h1 class="character-creation-title">Choose Your Archetype</h1>
                <p class="character-creation-subtitle">Select your starting archetype (optional - can skip)</p>
                
                <div class="archetype-selection">
                    <div class="archetype-option" data-archetype="light">
                        <img src="resources/create_archetype_light.png" class="archetype-image" alt="Light">
                        <div class="archetype-name">Light</div>
                    </div>
                    <div class="archetype-option" data-archetype="medium">
                        <img src="resources/create_archetype_medium.png" class="archetype-image" alt="Medium">
                        <div class="archetype-name">Medium</div>
                    </div>
                    <div class="archetype-option" data-archetype="heavy">
                        <img src="resources/create_archetype_heavy.png" class="archetype-image" alt="Heavy">
                        <div class="archetype-name">Heavy</div>
                    </div>
                    <div class="archetype-option" data-archetype="armoursmith">
                        <img src="resources/create_archetype_armoursmith.png" class="archetype-image" alt="Armoursmith">
                        <div class="archetype-name">Armoursmith</div>
                    </div>
                    <div class="archetype-option" data-archetype="weaponsmith">
                        <img src="resources/create_archetype_weaponsmith.png" class="archetype-image" alt="Weaponsmith">
                        <div class="archetype-name">Weaponsmith</div>
                    </div>
                    <div class="archetype-option" data-archetype="tailor">
                        <img src="resources/create_archetype_tailor.png" class="archetype-image" alt="Tailor">
                        <div class="archetype-name">Tailor</div>
                    </div>
                </div>
                
                <div class="char-creation-nav">
                    <button class="char-creation-btn" onclick="charCreation.prevStep();">← Back</button>
                    <button class="char-creation-btn skip" onclick="charCreation.skipArchetype();">Skip</button>
                    <button class="char-creation-btn" onclick="charCreation.nextStep();" id="btn-next-archetype">Next →</button>
                </div>
            </div>
            
            <!-- Step 5: Character Customization -->
            <div class="char-creation-step" id="step-customization">
                <h1 class="character-creation-title">Customize Your Character</h1>
                <p class="character-creation-subtitle">Customize your appearance</p>
                
                <div id="customization-content">
                    <!-- Will be populated by JavaScript based on gender -->
                </div>
                
                <div class="char-creation-nav">
                    <button class="char-creation-btn" onclick="charCreation.prevStep();">← Back</button>
                    <button class="char-creation-btn" onclick="charCreation.finishCreation();" id="btn-finish">Finish →</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="../music-player.js"></script>
    <script>
        // Character Creation System
        const charCreation = {
            currentStep: 1,
            totalSteps: 5,
            characterData: {
                playerName: null,
                nation: null,
                gender: null,
                archetype: null,
                head: null,
                hair: null,
                beard: null,
                bodyDetail: null,
                headDetail: null
            },
            
            init: function() {
                console.log('charCreation.init() called');
                this.setupNationSelection();
                this.setupGenderSelection();
                this.setupArchetypeSelection();
                
                // Setup player name input
                const nameInput = document.getElementById('player-name-input');
                if (nameInput) {
                    const updateNextButton = () => {
                        this.characterData.playerName = nameInput.value.trim();
                        const nextBtn = document.getElementById('btn-next-name');
                        if (nextBtn) {
                            nextBtn.disabled = !this.characterData.playerName;
                        }
                    };
                    
                    nameInput.addEventListener('input', updateNextButton);
                    nameInput.addEventListener('keyup', updateNextButton);
                    nameInput.addEventListener('change', updateNextButton);
                    updateNextButton();
                    
                    nameInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter' && this.characterData.playerName) {
                            e.preventDefault();
                            this.nextStep();
                        }
                    });
                }
                
                // Show first step
                this.showStep(1);
            },
            
            reset: function() {
                console.log('Resetting character creation');
                this.characterData = {
                    playerName: null,
                    nation: null,
                    gender: null,
                    archetype: null,
                    head: null,
                    hair: null,
                    beard: null,
                    bodyDetail: null,
                    headDetail: null
                };
                
                // Clear form
                const nameInput = document.getElementById('player-name-input');
                if (nameInput) nameInput.value = '';
                
                // Clear selections
                document.querySelectorAll('.nation-option, .gender-option, .archetype-option, .customization-item').forEach(el => {
                    el.classList.remove('selected');
                });
                
                // Reset images
                document.querySelectorAll('.nation-image').forEach(img => {
                    if (img.dataset.default) img.src = img.dataset.default;
                });
                
                // Show first step
                this.showStep(1);
            },
            
            showStep: function(step) {
                console.log('showStep called with step:', step);
                document.querySelectorAll('.char-creation-step').forEach(s => {
                    s.classList.remove('active');
                });
                
                const stepNames = ['nation', 'name', 'gender', 'archetype', 'customization'];
                const stepElement = document.getElementById(`step-${stepNames[step - 1]}`);
                if (stepElement) {
                    stepElement.classList.add('active');
                }
                
                this.currentStep = step;
                
                if (step === 5) {
                    this.loadCustomization();
                }
                
                if (step === 2) {
                    setTimeout(() => {
                        const nameInput = document.getElementById('player-name-input');
                        if (nameInput) {
                            nameInput.focus();
                        }
                    }, 100);
                }
            },
            
            nextStep: function() {
                if (this.currentStep < this.totalSteps) {
                    this.showStep(this.currentStep + 1);
                }
            },
            
            prevStep: function() {
                if (this.currentStep > 1) {
                    this.showStep(this.currentStep - 1);
                }
            },
            
            setupNationSelection: function() {
                const self = this;
                const nationOptions = document.querySelectorAll('.nation-option');
                
                nationOptions.forEach((option) => {
                    const img = option.querySelector('.nation-image');
                    const nation = option.dataset.nation;
                    
                    option.style.cursor = 'pointer';
                    option.style.pointerEvents = 'auto';
                    
                    option.addEventListener('mouseenter', () => {
                        if (img && img.dataset.hover && !option.classList.contains('selected')) {
                            img.src = img.dataset.hover;
                        }
                    });
                    
                    option.addEventListener('mouseleave', () => {
                        if (img && img.dataset.default && !option.classList.contains('selected')) {
                            img.src = img.dataset.default;
                        }
                    });
                    
                    const clickHandler = function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        nationOptions.forEach(opt => {
                            opt.classList.remove('selected');
                            const optImg = opt.querySelector('.nation-image');
                            if (optImg && optImg.dataset.default) {
                                optImg.src = optImg.dataset.default;
                            }
                        });
                        
                        option.classList.add('selected');
                        const selectedImg = option.querySelector('.nation-image');
                        if (selectedImg && selectedImg.dataset.hover) {
                            selectedImg.src = selectedImg.dataset.hover;
                        }
                        
                        self.characterData.nation = nation;
                        localStorage.setItem('gv_selected_nation', nation);
                        
                        // Apply theme
                        if (typeof window.applyTheme === 'function') {
                            window.applyTheme(nation);
                        }
                        if (typeof window.loadThemeCSS === 'function') {
                            window.loadThemeCSS(nation);
                        }
                        
                        setTimeout(() => {
                            self.nextStep();
                        }, 500);
                    };
                    
                    option.addEventListener('click', clickHandler, true);
                });
            },
            
            setupGenderSelection: function() {
                const genderOptions = document.querySelectorAll('.gender-option');
                const nextBtn = document.getElementById('btn-next-gender');
                
                genderOptions.forEach(option => {
                    const img = option.querySelector('.gender-image');
                    option.addEventListener('mouseenter', () => {
                        if (img && img.dataset.hover && !option.classList.contains('selected')) {
                            img.src = img.dataset.hover;
                        }
                    });
                    option.addEventListener('mouseleave', () => {
                        if (img && img.dataset.default && !option.classList.contains('selected')) {
                            img.src = img.dataset.default;
                        }
                    });
                    
                    option.addEventListener('click', () => {
                        genderOptions.forEach(opt => opt.classList.remove('selected'));
                        option.classList.add('selected');
                        this.characterData.gender = option.dataset.gender;
                        if (nextBtn) nextBtn.disabled = false;
                        
                        setTimeout(() => {
                            this.nextStep();
                        }, 500);
                    });
                });
            },
            
            setupArchetypeSelection: function() {
                const archetypeOptions = document.querySelectorAll('.archetype-option');
                
                archetypeOptions.forEach(option => {
                    option.addEventListener('click', () => {
                        archetypeOptions.forEach(opt => opt.classList.remove('selected'));
                        option.classList.add('selected');
                        this.characterData.archetype = option.dataset.archetype;
                    });
                });
            },
            
            skipArchetype: function() {
                this.characterData.archetype = null;
                localStorage.setItem('gv_archetype_skipped', 'true');
                this.nextStep();
            },
            
            loadCustomization: function() {
                const content = document.getElementById('customization-content');
                if (!content) return;
                
                const gender = this.characterData.gender || 'male';
                const basePath = 'resources/';
                
                let html = '';
                
                // Head selection
                html += '<div class="customization-category">';
                html += '<div class="customization-category-title">Head</div>';
                html += '<div class="customization-grid">';
                for (let i = 1; i <= 6; i++) {
                    html += `<div class="customization-item" data-type="head" data-value="${i}">
                        <img src="${basePath}create_slot_head_0${i}.png" class="customization-image" alt="Head ${i}">
                    </div>`;
                }
                html += '</div></div>';
                
                // Hair selection
                html += '<div class="customization-category">';
                html += '<div class="customization-category-title">Hair</div>';
                html += '<div class="customization-grid">';
                html += `<div class="customization-item" data-type="hair" data-value="none">
                    <img src="${basePath}create_slot_brak.png" class="customization-image" alt="None">
                </div>`;
                for (let i = 1; i <= 14; i++) {
                    const num = i < 10 ? `0${i}` : i;
                    html += `<div class="customization-item" data-type="hair" data-value="${i}">
                        <img src="${basePath}create_slot_hair_${num}.png" class="customization-image" alt="Hair ${i}">
                    </div>`;
                }
                html += '</div></div>';
                
                // Beard selection (only for male)
                if (gender === 'male') {
                    html += '<div class="customization-category">';
                    html += '<div class="customization-category-title">Beard</div>';
                    html += '<div class="customization-grid">';
                    html += `<div class="customization-item" data-type="beard" data-value="none">
                        <img src="${basePath}create_slot_brak.png" class="customization-image" alt="None">
                    </div>`;
                    for (let i = 1; i <= 8; i++) {
                        const num = i < 10 ? `0${i}` : i;
                        html += `<div class="customization-item" data-type="beard" data-value="${i}">
                            <img src="${basePath}create_slot_beard_${num}.png" class="customization-image" alt="Beard ${i}">
                        </div>`;
                    }
                    html += '</div></div>';
                }
                
                // Body Details
                html += '<div class="customization-category">';
                html += '<div class="customization-category-title">Body Details</div>';
                html += '<div class="customization-grid">';
                html += `<div class="customization-item" data-type="bodyDetail" data-value="none">
                    <img src="${basePath}create_slot_brak.png" class="customization-image" alt="None">
                </div>`;
                for (let i = 1; i <= 4; i++) {
                    const num = i < 10 ? `0${i}` : i;
                    html += `<div class="customization-item" data-type="bodyDetail" data-value="${i}">
                        <img src="${basePath}create_slot_detal_body_${num}.png" class="customization-image" alt="Body Detail ${i}">
                    </div>`;
                }
                html += '</div></div>';
                
                // Head Details
                html += '<div class="customization-category">';
                html += '<div class="customization-category-title">Head Details</div>';
                html += '<div class="customization-grid">';
                html += `<div class="customization-item" data-type="headDetail" data-value="none">
                    <img src="${basePath}create_slot_brak.png" class="customization-image" alt="None">
                </div>`;
                for (let i = 1; i <= 8; i++) {
                    const num = i < 10 ? `0${i}` : i;
                    html += `<div class="customization-item" data-type="headDetail" data-value="${i}">
                        <img src="${basePath}create_slot_detal_head_${num}.png" class="customization-image" alt="Head Detail ${i}">
                    </div>`;
                }
                html += '</div></div>';
                
                content.innerHTML = html;
                
                // Setup customization item clicks
                content.querySelectorAll('.customization-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const type = item.dataset.type;
                        const value = item.dataset.value;
                        
                        content.querySelectorAll(`.customization-item[data-type="${type}"]`).forEach(i => {
                            i.classList.remove('selected');
                        });
                        
                        item.classList.add('selected');
                        this.characterData[type] = value;
                    });
                });
            },
            
            finishCreation: function() {
                console.log('finishCreation called, saving character data:', this.characterData);
                
                if (!this.characterData.nation) {
                    alert('Please select a nation first');
                    this.showStep(1);
                    return;
                }
                
                if (!this.characterData.playerName) {
                    alert('Please enter a player name');
                    this.showStep(2);
                    return;
                }
                
                if (!this.characterData.gender) {
                    alert('Please select a gender');
                    this.showStep(3);
                    return;
                }
                
                // Prepare character data to save
                const dataToSave = {
                    playerName: this.characterData.playerName,
                    nation: this.characterData.nation,
                    gender: this.characterData.gender,
                    archetype: this.characterData.archetype || null,
                    head: this.characterData.head || null,
                    hair: this.characterData.hair || null,
                    beard: this.characterData.beard || null,
                    bodyDetail: this.characterData.bodyDetail || null,
                    headDetail: this.characterData.headDetail || null,
                    createdAt: new Date().toISOString()
                };
                
                // Load existing characters array (max 5)
                let characters = [];
                const existingData = localStorage.getItem('gv_characters');
                if (existingData) {
                    try {
                        characters = JSON.parse(existingData);
                    } catch(e) {
                        console.error('Error loading characters:', e);
                    }
                } else {
                    // Backward compatibility: check for old single character format
                    const oldCharData = localStorage.getItem('gv_character_data');
                    if (oldCharData) {
                        try {
                            const oldChar = JSON.parse(oldCharData);
                            oldChar.createdAt = new Date().toISOString();
                            characters = [oldChar];
                        } catch(e) {
                            console.error('Error migrating old character:', e);
                        }
                    }
                }
                
                // Check if we're at the limit (5 characters)
                if (characters.length >= 5) {
                    if (!confirm('You have reached the maximum of 5 characters. Creating a new character will delete the oldest one. Continue?')) {
                        return;
                    }
                    characters.shift();
                }
                
                // Add new character
                characters.push(dataToSave);
                
                // Save characters array
                localStorage.setItem('gv_characters', JSON.stringify(characters));
                
                // Also save as active character (for backward compatibility)
                localStorage.setItem('gv_character_data', JSON.stringify(dataToSave));
                localStorage.setItem('gv_selected_nation', this.characterData.nation);
                localStorage.setItem('gv_active_character_index', (characters.length - 1).toString());
                
                console.log('Character data saved successfully. Total characters:', characters.length);
                
                // Apply theme
                if (typeof window.applyTheme === 'function') {
                    window.applyTheme(this.characterData.nation);
                }
                if (typeof window.loadThemeCSS === 'function') {
                    window.loadThemeCSS(this.characterData.nation);
                }
                
                // Redirect to Workshop to view saved character
                alert('Character created successfully! Redirecting to Workshop...');
                window.location.href = '/workshop/';
            }
        };
        
        // Global function to reset character creation
        function resetCharacterCreation() {
            if (confirm('Are you sure you want to start a new character? All current progress will be lost.')) {
                charCreation.reset();
            }
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            charCreation.init();
            
            // Start music in main menu mode
            if (window.musicPlayer) {
                window.musicPlayer.switchToMainMenuMode();
                if (!window.musicPlayer.isPlaying) {
                    window.musicPlayer.play();
                }
            }
        });
    </script>
</body>
</html>

